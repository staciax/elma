// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["omitApi"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              String         @id @default(uuid(7)) @map("user_id")
  email           String         @unique @db.VarChar(255)
  first_name      String?        @db.VarChar(255) // TODO: recheck null or default
  last_name       String?        @db.VarChar(255)
  hashed_password String
  // salt           String
  is_superuser    Boolean        @default(false)
  is_staff        Boolean        @default(false)
  is_active       Boolean        @default(true) // TODO: active to false when sftp is implemented
  created_at      DateTime       @default(now())
  updated_at      DateTime       @updatedAt
  shopping_carts  ShoppingCart[]
  orders          Order[]

  @@index([email], name: "idx_users_email")
  @@map("users")
}

model Publisher {
  id       String    @id @default(uuid(7)) @map("publisher_id")
  name     String    @db.VarChar(255)
  products Product[]

  @@map("publishers")
}

model Category {
  id       String    @id @default(uuid(7)) @map("category_id")
  name     String    @db.VarChar(255)
  products Product[]

  @@map("categories")
}

model Series {
  id       String    @id @default(uuid(7)) @map("series_id")
  name     String    @db.VarChar(255)
  products Product[]

  @@map("series")
}

model Author {
  id         String          @id @default(uuid(7)) @map("author_id")
  first_name String          @db.VarChar(255)
  last_name  String          @db.VarChar(255)
  products   ProductAuthor[]

  @@map("authors")
}

// TODO: refactor to use S3 bucket for images
model ProductImage {
  id         String  @id @default(uuid(7))
  product_id String
  url        String  @db.VarChar(255)
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@map("product_images")
}

model Product {
  id              String          @id @default(uuid(7)) @map("product_id")
  title           String          @db.VarChar(255)
  description     String          @db.Text
  isbn            String          @db.VarChar(13) // @unique
  price           Decimal         @db.Decimal(10, 2)
  published_date  DateTime
  publisher       Publisher?      @relation(fields: [publisher_id], references: [id], onDelete: SetNull, onUpdate: Cascade)
  publisher_id    String?
  category        Category?       @relation(fields: [category_id], references: [id], onDelete: SetNull, onUpdate: Cascade)
  category_id     String?
  Series          Series?         @relation(fields: [series_id], references: [id], onDelete: SetNull, onUpdate: Cascade)
  series_id       String?
  images          ProductImage[]
  product_authors ProductAuthor[]
  shopping_carts  ShoppingCart[]
  order_items     OrderItem[]
  // TODO: add status active or inactive

  @@index([title], name: "idx_products_title")
  @@map("products")
}

model ProductAuthor {
  product_id String
  author_id  String
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  author     Author  @relation(fields: [author_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([product_id, author_id], name: "product_author_id")
  @@map("product_authors")
}

model ShoppingCart {
  product_id String
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  user_id    String
  user       User    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([product_id, user_id], name: "shopping_cart_id")
  @@map("shopping_carts")
}

model Order {
  id          String      @id @default(uuid(7)) @map("order_id")
  user_id     String
  user        User        @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  total_price Decimal     @db.Decimal(10, 2)
  status      String      @db.VarChar(255)
  created_at  DateTime    @default(now())
  updated_at  DateTime    @updatedAt
  items       OrderItem[]
  // Payment     Payment[]

  @@map("orders")
}

// TODO: enum for order status

model OrderItem {
  order_id   String
  product_id String
  product    Product @relation(fields: [product_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  order      Order   @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  price      Decimal @db.Decimal(10, 2)

  @@id([order_id, product_id], name: "order_item_id")
  @@map("order_items")
}

// TODO: payment model or 3rd party payment

// model Payment {
//   id         String   @id @default(uuid(7)) @map("payment_id")
//   order_id   String
//   order      Order    @relation(fields: [order_id], references: [id], onDelete: Cascade, onUpdate: Cascade)
//   amount     Decimal  @db.Decimal(10, 2)
//   created_at DateTime @default(now())
//   method     String   @db.VarChar(255)

//   @@map("payments")
// }
